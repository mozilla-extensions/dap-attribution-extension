<!DOCTYPE html>
<html>
  <title>Source Website</title>
  <body>
    <h1>This is a Source Website</h1>
    <p>This website simulates calling an ad server, displaying an ad, and recording impressions/clicks.</p>
    <button></button>
  </body>
  <script src="util/ads.js"></script>
  <script>
    const winningAd = callAdServer();

    // Get button and set name
    let btn = document.querySelector('button');
    btn.innerText = `Click ${winningAd.ad.name} Ad!`;
    btn.onclick = () => {
      clickAd(winningAd);
    }

    // BELOW IS CODE AD SUPPLIERS MUST IMPLEMENT

    reportImpression(winningAd);

    function reportImpression(ad) {
        // Track impression/view
        triggerEvent(ad.att.imp);
    }

    // Track click and redirect
    function clickAd(ad) {
      // Custom event triggered from extension, can be used for redirecting url and not failing in JS
      window.addEventListener("fx-attribution-complete", function attributionComplete(e) {
        window.removeEventListener("fx-attribution-complete", attributionComplete);
        window.open(ad.ad.url);
      }, false);

      // Track click
      triggerEvent(ad.att.cl);
    }


    function triggerEvent(detail) {
      window.dispatchEvent(
        new CustomEvent("fx-attribution", { detail })
      );
    }


    // This is an example response from an ad server.
    function callAdServer() {
      // Select a random ad
      const selectedAd = ads[Math.floor(Math.random() * ads.length)];

      selectedAd.ad.url = `file:///Users/bbirdsong/repos/dap-attribution-extension/websites/target.html?product=${selectedAd.ad.name.toLowerCase()}`;

      return selectedAd;
    }
  </script>
</html>
